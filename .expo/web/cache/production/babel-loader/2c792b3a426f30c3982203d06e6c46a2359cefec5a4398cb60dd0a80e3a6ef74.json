{"ast":null,"code":"import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";import _asyncToGenerator from\"@babel/runtime/helpers/asyncToGenerator\";import{computeNextBackoffInterval}from'@ide/backoff';import*as Application from'expo-application';import{CodedError,Platform,UnavailabilityError}from'expo-modules-core';import ServerRegistrationModule from\"../ServerRegistrationModule\";var updateDevicePushTokenUrl='https://exp.host/--/api/v2/push/updateDeviceToken';export function updateDevicePushTokenAsync(_x,_x2){return _updateDevicePushTokenAsync.apply(this,arguments);}function _updateDevicePushTokenAsync(){_updateDevicePushTokenAsync=_asyncToGenerator(function*(signal,token){var doUpdateDevicePushTokenAsync=function(){var _ref=_asyncToGenerator(function*(retry){var _yield$Promise$all=yield Promise.all([shouldUseDevelopmentNotificationService(),getDeviceIdAsync()]),_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2),development=_yield$Promise$all2[0],deviceId=_yield$Promise$all2[1];var body={deviceId:deviceId.toLowerCase(),development:development,deviceToken:token.data,appId:Application.applicationId,type:getTypeOfToken(token)};try{var response=yield fetch(updateDevicePushTokenUrl,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body),signal:signal});if(!response.ok){console.debug('[expo-notifications] Error encountered while updating the device push token with the server:',yield response.text());}if(!response.ok){retry();}}catch(e){if(e.name==='AbortError'){return;}console.warn('[expo-notifications] Error thrown while updating the device push token with the server:',e);retry();}});return function doUpdateDevicePushTokenAsync(_x3){return _ref.apply(this,arguments);};}();var shouldTry=true;var retry=function retry(){shouldTry=true;};var retriesCount=0;var initialBackoff=500;var backoffOptions={maxBackoff:2*60*1000};var nextBackoffInterval=computeNextBackoffInterval(initialBackoff,retriesCount,backoffOptions);while(shouldTry&&!signal.aborted){shouldTry=false;yield doUpdateDevicePushTokenAsync(retry);if(shouldTry&&!signal.aborted){nextBackoffInterval=computeNextBackoffInterval(initialBackoff,retriesCount,backoffOptions);retriesCount+=1;yield new Promise(function(resolve){return setTimeout(resolve,nextBackoffInterval);});}}});return _updateDevicePushTokenAsync.apply(this,arguments);}function getDeviceIdAsync(){return _getDeviceIdAsync.apply(this,arguments);}function _getDeviceIdAsync(){_getDeviceIdAsync=_asyncToGenerator(function*(){try{if(!ServerRegistrationModule.getInstallationIdAsync){throw new UnavailabilityError('ExpoServerRegistrationModule','getInstallationIdAsync');}return yield ServerRegistrationModule.getInstallationIdAsync();}catch(e){throw new CodedError('ERR_NOTIFICATIONS_DEVICE_ID',\"Could not fetch the installation ID of the application: \"+e+\".\");}});return _getDeviceIdAsync.apply(this,arguments);}function getTypeOfToken(devicePushToken){switch(devicePushToken.type){case'ios':return'apns';case'android':return'fcm';default:return devicePushToken.type;}}function shouldUseDevelopmentNotificationService(){return _shouldUseDevelopmentNotificationService.apply(this,arguments);}function _shouldUseDevelopmentNotificationService(){_shouldUseDevelopmentNotificationService=_asyncToGenerator(function*(){if(Platform.OS==='ios'){try{var notificationServiceEnvironment=yield Application.getIosPushNotificationServiceEnvironmentAsync();if(notificationServiceEnvironment==='development'){return true;}}catch(_unused){}}return false;});return _shouldUseDevelopmentNotificationService.apply(this,arguments);}","map":{"version":3,"names":["computeNextBackoffInterval","Application","CodedError","Platform","UnavailabilityError","ServerRegistrationModule","updateDevicePushTokenUrl","updateDevicePushTokenAsync","_x","_x2","_updateDevicePushTokenAsync","apply","arguments","_asyncToGenerator","signal","token","doUpdateDevicePushTokenAsync","_ref","retry","_yield$Promise$all","Promise","all","shouldUseDevelopmentNotificationService","getDeviceIdAsync","_yield$Promise$all2","_slicedToArray","development","deviceId","body","toLowerCase","deviceToken","data","appId","applicationId","type","getTypeOfToken","response","fetch","method","headers","JSON","stringify","ok","console","debug","text","e","name","warn","_x3","shouldTry","retriesCount","initialBackoff","backoffOptions","maxBackoff","nextBackoffInterval","aborted","resolve","setTimeout","_getDeviceIdAsync","getInstallationIdAsync","devicePushToken","_shouldUseDevelopmentNotificationService","OS","notificationServiceEnvironment","getIosPushNotificationServiceEnvironmentAsync","_unused"],"sources":["/Users/jinwook/react-native/daily-pt-frontend/node_modules/expo-notifications/src/utils/updateDevicePushTokenAsync.ts"],"sourcesContent":["import { computeNextBackoffInterval } from '@ide/backoff';\nimport * as Application from 'expo-application';\nimport { CodedError, Platform, UnavailabilityError } from 'expo-modules-core';\n\nimport ServerRegistrationModule from '../ServerRegistrationModule';\nimport { DevicePushToken } from '../Tokens.types';\n\nconst updateDevicePushTokenUrl = 'https://exp.host/--/api/v2/push/updateDeviceToken';\n\nexport async function updateDevicePushTokenAsync(signal: AbortSignal, token: DevicePushToken) {\n  const doUpdateDevicePushTokenAsync = async (retry: () => void) => {\n    const [development, deviceId] = await Promise.all([\n      shouldUseDevelopmentNotificationService(),\n      getDeviceIdAsync(),\n    ]);\n    const body = {\n      deviceId: deviceId.toLowerCase(),\n      development,\n      deviceToken: token.data,\n      appId: Application.applicationId,\n      type: getTypeOfToken(token),\n    };\n\n    try {\n      const response = await fetch(updateDevicePushTokenUrl, {\n        method: 'POST',\n        headers: {\n          'content-type': 'application/json',\n        },\n        body: JSON.stringify(body),\n        signal,\n      });\n\n      // Help debug erroring servers\n      if (!response.ok) {\n        console.debug(\n          '[expo-notifications] Error encountered while updating the device push token with the server:',\n          await response.text()\n        );\n      }\n\n      // Retry if request failed\n      if (!response.ok) {\n        retry();\n      }\n    } catch (e) {\n      // Error returned if the request is aborted should be an 'AbortError'. In\n      // React Native fetch is polyfilled using `whatwg-fetch` which:\n      // - creates `AbortError`s like this\n      //   https://github.com/github/fetch/blob/75d9455d380f365701151f3ac85c5bda4bbbde76/fetch.js#L505\n      // - which creates exceptions like\n      //   https://github.com/github/fetch/blob/75d9455d380f365701151f3ac85c5bda4bbbde76/fetch.js#L490-L494\n      if (e.name === 'AbortError') {\n        // We don't consider AbortError a failure, it's a sign somewhere else the\n        // request is expected to succeed and we don't need this one, so let's\n        // just return.\n        return;\n      }\n\n      console.warn(\n        '[expo-notifications] Error thrown while updating the device push token with the server:',\n        e\n      );\n\n      retry();\n    }\n  };\n\n  let shouldTry = true;\n  const retry = () => {\n    shouldTry = true;\n  };\n\n  let retriesCount = 0;\n  const initialBackoff = 500; // 0.5 s\n  const backoffOptions = {\n    maxBackoff: 2 * 60 * 1000, // 2 minutes\n  };\n  let nextBackoffInterval = computeNextBackoffInterval(\n    initialBackoff,\n    retriesCount,\n    backoffOptions\n  );\n\n  while (shouldTry && !signal.aborted) {\n    // Will be set to true by `retry` if it's called\n    shouldTry = false;\n    await doUpdateDevicePushTokenAsync(retry);\n\n    // Do not wait if we won't retry\n    if (shouldTry && !signal.aborted) {\n      nextBackoffInterval = computeNextBackoffInterval(\n        initialBackoff,\n        retriesCount,\n        backoffOptions\n      );\n      retriesCount += 1;\n      await new Promise((resolve) => setTimeout(resolve, nextBackoffInterval));\n    }\n  }\n}\n\n// Same as in getExpoPushTokenAsync\nasync function getDeviceIdAsync() {\n  try {\n    if (!ServerRegistrationModule.getInstallationIdAsync) {\n      throw new UnavailabilityError('ExpoServerRegistrationModule', 'getInstallationIdAsync');\n    }\n\n    return await ServerRegistrationModule.getInstallationIdAsync();\n  } catch (e) {\n    throw new CodedError(\n      'ERR_NOTIFICATIONS_DEVICE_ID',\n      `Could not fetch the installation ID of the application: ${e}.`\n    );\n  }\n}\n\n// Same as in getExpoPushTokenAsync\nfunction getTypeOfToken(devicePushToken: DevicePushToken) {\n  switch (devicePushToken.type) {\n    case 'ios':\n      return 'apns';\n    case 'android':\n      return 'fcm';\n    // This probably will error on server, but let's make this function future-safe.\n    default:\n      return devicePushToken.type;\n  }\n}\n\n// Same as in getExpoPushTokenAsync\nasync function shouldUseDevelopmentNotificationService() {\n  if (Platform.OS === 'ios') {\n    try {\n      const notificationServiceEnvironment =\n        await Application.getIosPushNotificationServiceEnvironmentAsync();\n      if (notificationServiceEnvironment === 'development') {\n        return true;\n      }\n    } catch {\n      // We can't do anything here, we'll fallback to false then.\n    }\n  }\n\n  return false;\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}